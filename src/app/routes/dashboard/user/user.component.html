<div>
  <nz-card nzTitle="用户管理">
    <div nz-row nzType="flex" nzJustify="space-between" nzAlign="middle">
      <div nz-col>
        <label for="step">步骤：</label>
        <nz-select
          id="step"
          [(ngModel)]="step"
          (ngModelChange)="onChangeStep($event)"
          [nzAllowClear]="true"
          nzPlaceHolder="全部"
          class="step-select"
        >
          <ng-container *ngFor="let step of steps">
            <nz-option [nzValue]="step?.idNode" [nzLabel]="step?.name"></nz-option>
          </ng-container>
        </nz-select>
        <label for="username" class="ml-lg">姓名/手机号：</label>
        <nz-input-group [nzSuffix]="suffixTemplate">
          <input
            nz-input
            class="width-md"
            [(ngModel)]="username"
            (keyup.enter)="search()"
            id="username"
            name="username"
            placeholder="请输入姓名或手机号关键字"
            autocomplete="off"
          />
        </nz-input-group>
        <ng-template #suffixTemplate
          ><i
            nz-icon
            nz-tooltip
            class="ant-input-clear-icon"
            nzTheme="fill"
            nzType="close-circle"
            *ngIf="username"
            (click)="inputClear()"
            title="删除"
          ></i
        ></ng-template>
        <button (click)="search()" nz-button class="ml-sm">查询</button>
      </div>
      <div nz-col>
        <button nzType="primary" (click)="addUser()" nz-button>新增用户</button>
      </div>
    </div>
  </nz-card>
  <nz-card>
    <nz-table
      #usersTable
      [nzData]="users"
      [nzSize]="'middle'"
      [nzFrontPagination]="false"
      [nzTotal]="total"
      [nzShowTotal]="totalTemplate"
      [nzShowQuickJumper]="true"
      [nzShowSizeChanger]="true"
      [nzLoading]="tableLoading"
      [nzLoadingDelay]="2"
      [(nzPageIndex)]="pageIndex"
      [(nzPageSize)]="pageSize"
      (nzPageIndexChange)="getUers()"
      (nzPageSizeChange)="getUers()"
    >
      <thead>
        <tr>
          <th [nzWidth]="'70px'">序号</th>
          <th [nzWidth]="'100px'">用户姓名</th>
          <th [nzWidth]="'180px'">手机号</th>
          <th [nzWidth]="'160px'">角色</th>
          <th [nzWidth]="'200px'">录入时间</th>
          <th [nzWidth]="'260px'">当前所在步骤</th>
          <th [nzWidth]="'380px'">操作</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of usersTable.data; let i = index">
          <td>{{ (pageIndex - 1) * pageSize + i + 1 }}</td>
          <td>{{ user?.realName }}</td>
          <td>{{ user?.phoneNum }}</td>
          <td>{{ user?.roleName }}</td>
          <td>{{ user?.startTime }}</td>
          <td>{{ user?.nodeName }}</td>
          <td>
            <button
              nz-button
              nzType="link"
              [disabled]="user?.roleName !== '个人'"
              [title]="user?.roleName !== '个人' ? '非个人角色的用户不能查看流程' : ''"
              (click)="viewProcess(user)"
            >
              查看流程
            </button>
            <nz-divider nzType="vertical" *ngIf="currentUserInfo.roleId === 1"></nz-divider>
            <button
              nz-button
              nzType="link"
              (click)="lockOrUnlockUser(user)"
              [disabled]="user.idRole === 1"
              [title]="user.idRole === 1 ? '系统管理员用户不能被锁定' : ''"
              *ngIf="currentUserInfo.roleId === 1"
            >
              {{ user?.dataState === 0 ? '解锁' : '锁定' }}
            </button>
            <nz-divider nzType="vertical"></nz-divider>
            <button
              nz-button
              nzType="link"
              (click)="updateUser(user)"
              [disabled]="user.idRole === 1"
              [title]="user.idRole === 1 ? '系统管理员用户信息不能被修改' : ''"
            >
              修改
            </button>
            <nz-divider nzType="vertical" *ngIf="currentUserInfo.roleId === 1"></nz-divider>
            <button
              nz-button
              nzType="link"
              (click)="resetPassword(user)"
              [disabled]="user.idRole === 1"
              [title]="user.idRole === 1 ? '系统管理员用户不能被重置密码' : ''"
              *ngIf="currentUserInfo.roleId === 1"
            >
              重置密码
            </button>
            <nz-divider nzType="vertical" *ngIf="currentUserInfo.roleId === 1"></nz-divider>
            <button
              nz-button
              nzType="link"
              [disabled]="currentUserInfo.userId === user.idUser"
              *ngIf="currentUserInfo.roleId === 1"
              (click)="deleteUser(user)"
              [title]="currentUserInfo.userId === user.idUser ? '不能够删除自己' : '删除用户'"
            >
              删除
            </button>
          </td>
        </tr>
      </tbody>
    </nz-table>
    <ng-template #totalTemplate let-total>共 {{ total }} 条</ng-template>
  </nz-card>
</div>
